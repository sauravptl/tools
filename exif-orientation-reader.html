<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EXIF Orientation Reader</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .drop-zone {
            transition: all 0.2s ease;
        }
        .drop-zone.dragover {
            border-color: #8b5cf6;
            background-color: rgba(139, 92, 246, 0.1);
            transform: scale(1.01);
        }
        .debug-log {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 12px;
            line-height: 1.6;
        }
        .log-info { color: #94a3b8; }
        .log-success { color: #4ade80; }
        .log-warning { color: #fbbf24; }
        .log-error { color: #f87171; }
        .log-value { color: #a78bfa; }
        .orientation-visual {
            transition: transform 0.3s ease;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-900 via-violet-950 to-slate-900 text-white">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <!-- Header -->
        <header class="text-center mb-8">
            <div class="inline-flex items-center gap-3 mb-3">
                <div class="w-11 h-11 bg-gradient-to-br from-violet-500 to-purple-600 rounded-xl flex items-center justify-center">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                </div>
            </div>
            <h1 class="text-3xl font-bold bg-gradient-to-r from-violet-400 to-purple-400 bg-clip-text text-transparent mb-2">
                EXIF Orientation Reader
            </h1>
            <p class="text-slate-400 max-w-2xl mx-auto">
                Extract TIFF orientation metadata from JPEG images. View the orientation tag and debug info 
                showing EXIF parsing, endianness detection, and TIFF header validation.
            </p>
        </header>

        <!-- Drop Zone -->
        <div id="dropZone" class="drop-zone border-2 border-dashed border-slate-600 rounded-2xl p-12 text-center cursor-pointer hover:border-violet-500 hover:bg-slate-800/30 mb-6">
            <div class="flex flex-col items-center gap-4">
                <div class="w-16 h-16 bg-slate-700/50 rounded-2xl flex items-center justify-center">
                    <svg class="w-8 h-8 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                    </svg>
                </div>
                <div>
                    <p class="text-lg font-medium text-slate-300">Drop JPEG image here or click to browse</p>
                    <p class="text-sm text-slate-500 mt-1">JPEG/JPG files with EXIF data</p>
                </div>
            </div>
            <input type="file" id="fileInput" accept=".jpg,.jpeg,image/jpeg" class="hidden">
        </div>

        <!-- Results Section -->
        <div id="resultsSection" class="hidden space-y-6">
            <!-- File Info -->
            <div class="bg-slate-800/60 rounded-xl p-5 border border-slate-700/50">
                <div class="flex items-start gap-4">
                    <div id="imagePreview" class="w-24 h-24 bg-slate-700 rounded-lg overflow-hidden flex-shrink-0">
                        <img id="previewImg" class="w-full h-full object-cover">
                    </div>
                    <div class="flex-1 min-w-0">
                        <h3 id="fileName" class="font-semibold text-slate-200 truncate">filename.jpg</h3>
                        <p id="fileSize" class="text-sm text-slate-500 mt-1">0 KB</p>
                        <button id="newFileBtn" class="mt-3 text-sm text-violet-400 hover:text-violet-300 transition-colors">
                            ‚Üê Analyze another file
                        </button>
                    </div>
                </div>
            </div>

            <!-- Orientation Result -->
            <div id="orientationResult" class="bg-slate-800/60 rounded-xl p-6 border border-slate-700/50">
                <h3 class="text-lg font-semibold text-slate-200 mb-4">Orientation Tag</h3>
                <div class="flex items-center gap-6">
                    <!-- Visual representation -->
                    <div class="flex-shrink-0">
                        <div id="orientationVisual" class="orientation-visual w-20 h-28 bg-slate-700 rounded-lg border-2 border-violet-500 flex items-center justify-center relative">
                            <div class="absolute top-1 left-1/2 -translate-x-1/2 w-6 h-1 bg-violet-400 rounded"></div>
                            <span class="text-2xl">üì∑</span>
                        </div>
                        <p class="text-xs text-slate-500 text-center mt-2">Visual</p>
                    </div>
                    <!-- Details -->
                    <div class="flex-1">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <p class="text-xs text-slate-500 mb-1">Orientation Value</p>
                                <p id="orientationValue" class="text-2xl font-bold text-violet-400">-</p>
                            </div>
                            <div>
                                <p class="text-xs text-slate-500 mb-1">Hex Value</p>
                                <p id="orientationHex" class="text-2xl font-bold text-slate-400 font-mono">-</p>
                            </div>
                        </div>
                        <div class="mt-4">
                            <p class="text-xs text-slate-500 mb-1">Description</p>
                            <p id="orientationDesc" class="text-slate-200">-</p>
                        </div>
                        <div class="mt-3">
                            <p class="text-xs text-slate-500 mb-1">CSS Transform</p>
                            <code id="cssTransform" class="text-sm text-purple-400 bg-slate-900/50 px-2 py-1 rounded">-</code>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Orientation Reference -->
            <div class="bg-slate-800/40 rounded-xl p-5 border border-slate-700/50">
                <h4 class="text-sm font-semibold text-slate-300 mb-3">Orientation Values Reference</h4>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-xs">
                    <div class="bg-slate-900/50 p-3 rounded-lg">
                        <span class="font-bold text-violet-400">1</span>
                        <span class="text-slate-400"> - Normal</span>
                    </div>
                    <div class="bg-slate-900/50 p-3 rounded-lg">
                        <span class="font-bold text-violet-400">2</span>
                        <span class="text-slate-400"> - Flip horizontal</span>
                    </div>
                    <div class="bg-slate-900/50 p-3 rounded-lg">
                        <span class="font-bold text-violet-400">3</span>
                        <span class="text-slate-400"> - Rotate 180¬∞</span>
                    </div>
                    <div class="bg-slate-900/50 p-3 rounded-lg">
                        <span class="font-bold text-violet-400">4</span>
                        <span class="text-slate-400"> - Flip vertical</span>
                    </div>
                    <div class="bg-slate-900/50 p-3 rounded-lg">
                        <span class="font-bold text-violet-400">5</span>
                        <span class="text-slate-400"> - Rotate 90¬∞ CW + Flip H</span>
                    </div>
                    <div class="bg-slate-900/50 p-3 rounded-lg">
                        <span class="font-bold text-violet-400">6</span>
                        <span class="text-slate-400"> - Rotate 90¬∞ CW</span>
                    </div>
                    <div class="bg-slate-900/50 p-3 rounded-lg">
                        <span class="font-bold text-violet-400">7</span>
                        <span class="text-slate-400"> - Rotate 90¬∞ CCW + Flip H</span>
                    </div>
                    <div class="bg-slate-900/50 p-3 rounded-lg">
                        <span class="font-bold text-violet-400">8</span>
                        <span class="text-slate-400"> - Rotate 90¬∞ CCW</span>
                    </div>
                </div>
            </div>

            <!-- Debug Log -->
            <div class="bg-slate-800/60 rounded-xl overflow-hidden border border-slate-700/50">
                <div class="flex items-center justify-between px-5 py-3 bg-slate-700/50 border-b border-slate-700/50">
                    <h3 class="text-sm font-semibold text-slate-300">Debug Log</h3>
                    <button id="clearLogBtn" class="text-xs text-slate-500 hover:text-slate-300 transition-colors">Clear</button>
                </div>
                <div id="debugLog" class="debug-log p-4 max-h-80 overflow-y-auto bg-slate-900/50">
                    <p class="text-slate-600">Waiting for file...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const resultsSection = document.getElementById('resultsSection');
        const debugLog = document.getElementById('debugLog');

        let logLines = [];

        // Orientation descriptions
        const orientationInfo = {
            1: { desc: 'Normal (Top-left)', transform: 'none', rotation: 0 },
            2: { desc: 'Flipped horizontally (Top-right)', transform: 'scaleX(-1)', rotation: 0, flipH: true },
            3: { desc: 'Rotated 180¬∞ (Bottom-right)', transform: 'rotate(180deg)', rotation: 180 },
            4: { desc: 'Flipped vertically (Bottom-left)', transform: 'scaleY(-1)', rotation: 0, flipV: true },
            5: { desc: 'Rotated 90¬∞ CW + Flipped horizontally', transform: 'rotate(90deg) scaleX(-1)', rotation: 90, flipH: true },
            6: { desc: 'Rotated 90¬∞ clockwise (Right-top)', transform: 'rotate(90deg)', rotation: 90 },
            7: { desc: 'Rotated 90¬∞ CCW + Flipped horizontally', transform: 'rotate(-90deg) scaleX(-1)', rotation: -90, flipH: true },
            8: { desc: 'Rotated 90¬∞ counter-clockwise (Left-bottom)', transform: 'rotate(-90deg)', rotation: -90 }
        };

        // Logging functions
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            logLines.push({ timestamp, message, type });
            renderLog();
        }

        function renderLog() {
            debugLog.innerHTML = logLines.map(line => 
                `<div class="log-${line.type}"><span class="text-slate-600">[${line.timestamp}]</span> ${line.message}</div>`
            ).join('');
            debugLog.scrollTop = debugLog.scrollHeight;
        }

        function clearLog() {
            logLines = [];
            renderLog();
        }

        // File handling
        dropZone.addEventListener('click', () => fileInput.click());

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            if (e.dataTransfer.files.length > 0) {
                processFile(e.dataTransfer.files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                processFile(e.target.files[0]);
            }
        });

        document.getElementById('newFileBtn').addEventListener('click', () => {
            resultsSection.classList.add('hidden');
            dropZone.classList.remove('hidden');
            fileInput.value = '';
            clearLog();
        });

        document.getElementById('clearLogBtn').addEventListener('click', clearLog);

        async function processFile(file) {
            clearLog();
            log(`Processing file: <span class="log-value">${file.name}</span>`);
            log(`File size: <span class="log-value">${formatBytes(file.size)}</span>`);
            log(`MIME type: <span class="log-value">${file.type || 'unknown'}</span>`);

            // Show preview
            const previewUrl = URL.createObjectURL(file);
            document.getElementById('previewImg').src = previewUrl;
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileSize').textContent = formatBytes(file.size);

            dropZone.classList.add('hidden');
            resultsSection.classList.remove('hidden');

            try {
                const arrayBuffer = await file.arrayBuffer();
                const dataView = new DataView(arrayBuffer);

                log(`Reading file as ArrayBuffer (${arrayBuffer.byteLength} bytes)`, 'info');

                // Check for JPEG signature
                const jpegMarker = dataView.getUint16(0);
                log(`Checking JPEG marker at offset 0: <span class="log-value">0x${jpegMarker.toString(16).toUpperCase()}</span>`);

                if (jpegMarker !== 0xFFD8) {
                    log('Invalid JPEG file - missing SOI marker (0xFFD8)', 'error');
                    showNoOrientation('Not a valid JPEG file');
                    return;
                }
                log('Valid JPEG SOI marker found', 'success');

                // Find EXIF data
                const exifResult = findEXIF(dataView);
                if (!exifResult) {
                    showNoOrientation('No EXIF data found in file');
                    return;
                }

                const { offset: exifOffset, length: exifLength } = exifResult;
                log(`EXIF APP1 segment found at offset <span class="log-value">${exifOffset}</span>, length: <span class="log-value">${exifLength}</span> bytes`, 'success');

                // Parse EXIF
                const orientation = parseEXIF(dataView, exifOffset);
                
                if (orientation !== null) {
                    displayOrientation(orientation);
                } else {
                    showNoOrientation('Orientation tag not found in EXIF data');
                }

            } catch (err) {
                log(`Error: ${err.message}`, 'error');
                showNoOrientation('Error parsing file');
            }
        }

        function findEXIF(dataView) {
            let offset = 2; // Skip SOI marker
            
            log('Scanning for APP1 (EXIF) marker...', 'info');

            while (offset < dataView.byteLength - 4) {
                const marker = dataView.getUint16(offset);
                
                if (marker === 0xFFE1) { // APP1 marker
                    const length = dataView.getUint16(offset + 2);
                    
                    // Check for "Exif\0\0" identifier
                    const exifId = String.fromCharCode(
                        dataView.getUint8(offset + 4),
                        dataView.getUint8(offset + 5),
                        dataView.getUint8(offset + 6),
                        dataView.getUint8(offset + 7)
                    );
                    
                    log(`Found APP1 marker at offset ${offset}, checking identifier: "<span class="log-value">${exifId}</span>"`, 'info');
                    
                    if (exifId === 'Exif') {
                        return { offset: offset + 4, length: length - 2 };
                    }
                }

                if ((marker & 0xFF00) !== 0xFF00) {
                    log(`Invalid marker at offset ${offset}: 0x${marker.toString(16)}`, 'warning');
                    break;
                }

                // Move to next marker
                if (marker === 0xFFD8 || marker === 0xFFD9) {
                    offset += 2;
                } else {
                    const segmentLength = dataView.getUint16(offset + 2);
                    offset += 2 + segmentLength;
                }
            }

            log('No EXIF APP1 segment found', 'warning');
            return null;
        }

        function parseEXIF(dataView, exifStart) {
            // Skip "Exif\0\0" (6 bytes)
            const tiffStart = exifStart + 6;
            
            log(`TIFF header starts at offset <span class="log-value">${tiffStart}</span>`, 'info');

            // Read byte order
            const byteOrder = dataView.getUint16(tiffStart);
            const littleEndian = byteOrder === 0x4949; // "II" = Intel = Little Endian
            
            log(`Byte order marker: <span class="log-value">0x${byteOrder.toString(16).toUpperCase()}</span> (${littleEndian ? 'Little Endian - Intel' : 'Big Endian - Motorola'})`, 'info');

            // Validate TIFF magic number (42)
            const tiffMagic = dataView.getUint16(tiffStart + 2, littleEndian);
            log(`TIFF magic number: <span class="log-value">${tiffMagic}</span> (expected: 42)`, tiffMagic === 42 ? 'success' : 'error');

            if (tiffMagic !== 42) {
                log('Invalid TIFF header', 'error');
                return null;
            }

            // Get IFD0 offset
            const ifd0Offset = dataView.getUint32(tiffStart + 4, littleEndian);
            log(`IFD0 offset: <span class="log-value">${ifd0Offset}</span> (absolute: ${tiffStart + ifd0Offset})`, 'info');

            // Read IFD0
            const ifdStart = tiffStart + ifd0Offset;
            const numEntries = dataView.getUint16(ifdStart, littleEndian);
            log(`IFD0 contains <span class="log-value">${numEntries}</span> entries`, 'info');

            // Search for orientation tag (0x0112)
            for (let i = 0; i < numEntries; i++) {
                const entryOffset = ifdStart + 2 + (i * 12);
                const tag = dataView.getUint16(entryOffset, littleEndian);
                
                if (tag === 0x0112) { // Orientation tag
                    const type = dataView.getUint16(entryOffset + 2, littleEndian);
                    const count = dataView.getUint32(entryOffset + 4, littleEndian);
                    const value = dataView.getUint16(entryOffset + 8, littleEndian);

                    log(`Found Orientation tag (0x0112) at entry ${i}`, 'success');
                    log(`  Tag: <span class="log-value">0x${tag.toString(16).toUpperCase()}</span>`, 'info');
                    log(`  Type: <span class="log-value">${type}</span> (${getTypeName(type)})`, 'info');
                    log(`  Count: <span class="log-value">${count}</span>`, 'info');
                    log(`  Value: <span class="log-value">${value}</span> (0x${value.toString(16).toUpperCase()})`, 'success');

                    return value;
                }
            }

            log('Orientation tag (0x0112) not found in IFD0', 'warning');
            
            // Check for EXIF SubIFD
            for (let i = 0; i < numEntries; i++) {
                const entryOffset = ifdStart + 2 + (i * 12);
                const tag = dataView.getUint16(entryOffset, littleEndian);
                
                if (tag === 0x8769) { // EXIF SubIFD pointer
                    const subIfdOffset = dataView.getUint32(entryOffset + 8, littleEndian);
                    log(`Found EXIF SubIFD pointer, offset: ${subIfdOffset}`, 'info');
                }
            }

            return null;
        }

        function getTypeName(type) {
            const types = {
                1: 'BYTE', 2: 'ASCII', 3: 'SHORT', 4: 'LONG', 5: 'RATIONAL',
                6: 'SBYTE', 7: 'UNDEFINED', 8: 'SSHORT', 9: 'SLONG', 10: 'SRATIONAL',
                11: 'FLOAT', 12: 'DOUBLE'
            };
            return types[type] || 'UNKNOWN';
        }

        function displayOrientation(value) {
            const info = orientationInfo[value] || { desc: 'Unknown', transform: 'none', rotation: 0 };

            document.getElementById('orientationValue').textContent = value;
            document.getElementById('orientationHex').textContent = '0x' + value.toString(16).toUpperCase().padStart(4, '0');
            document.getElementById('orientationDesc').textContent = info.desc;
            document.getElementById('cssTransform').textContent = `transform: ${info.transform};`;

            // Update visual
            const visual = document.getElementById('orientationVisual');
            visual.style.transform = info.transform;

            log(`Orientation successfully extracted: <span class="log-value">${value}</span> - ${info.desc}`, 'success');
        }

        function showNoOrientation(message) {
            document.getElementById('orientationValue').textContent = '-';
            document.getElementById('orientationHex').textContent = '-';
            document.getElementById('orientationDesc').textContent = message;
            document.getElementById('cssTransform').textContent = 'N/A';
            document.getElementById('orientationVisual').style.transform = 'none';
            
            log(message, 'warning');
        }

        function formatBytes(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
        }
    </script>
</body>
</html>
